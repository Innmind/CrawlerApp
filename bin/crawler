#!/usr/bin/env php
<?php
declare(strict_types = 1);

require __DIR__.'/../vendor/autoload.php';

use function Crawler\bootstrap;
use Innmind\CLI\{
    Main,
    Environment,
};
use Innmind\Url\{
    Url,
    Path,
};
use Innmind\Socket\Internet\Transport;
use Innmind\OperatingSystem\OperatingSystem;
use function Innmind\CLI\variables;

new class extends Main {
    protected function main(Environment $env, OperatingSystem $os): void
    {
        $variables = variables(
            $env->variables(),
            $os->filesystem()->mount(new Path(__DIR__.'/../config'))
        );

        $dir = __DIR__.'/../';
        $run = bootstrap(
            $os,
            Url::fromString("file://$dir/var/logs/app.log"),
            Url::fromString("file://$dir/var/logs/amqp/amqp.log"),
            $os->filesystem()->mount(new Path($dir.'/var/cache/rest')),
            $os->filesystem()->mount(new Path($dir.'/var/logs')),
            $os->filesystem()->mount(new Path($dir.'/var/data/states')),
            $os->filesystem()->mount(new Path($dir.'/var/data/actions')),
            $os->filesystem()->mount(new Path($dir.'/var/cache/traces')),
            $os->filesystem()->mount(new Path($dir.'/var/cache/robots_txts')),
            $env->workingDirectory(),
            Transport::tcp(),
            Url::fromString($variables['amqpServer'] ?? 'amqp://guest:guest@localhost:5672/'),
            $variables['apiKey'],
            'Innmind Robot'
        );

        $run($env);
    }
};

#!/usr/bin/env php
<?php
declare(strict_types = 1);

require __DIR__.'/../vendor/autoload.php';

use function Crawler\bootstrap;
use Innmind\CLI\{
    Main,
    Environment,
    Commands,
};
use Innmind\Url\{
    Url,
    Path,
};
use Innmind\Socket\Internet\Transport;
use Innmind\OperatingSystem\OperatingSystem;
use Innmind\Debug\{
    CodeEditor,
    Profiler\Section\CaptureAppGraph,
};
use Innmind\Immutable\Set;
use function Innmind\CLI\variables;
use function Innmind\Debug\bootstrap as debug;
use function Innmind\SilentCartographer\bootstrap as cartographer;

new class extends Main {
    protected function main(Environment $env, OperatingSystem $os): void
    {
        $os = cartographer($os)['cli'](Url::fromString(__DIR__));

        $variables = variables(
            $env->variables(),
            $os->filesystem()->mount(new Path(__DIR__.'/../config'))
        );

        if ($variables->contains('debug')) {
            $debug = debug(
                $os,
                Url::fromString($variables->get('profiler')),
                $variables,
                CodeEditor::sublimeText(),
                Set::of('string', CaptureAppGraph::class)
            );
            $os = $debug['os']();
        }

        $dir = __DIR__.'/../';
        $commands = bootstrap(
            $os,
            Url::fromString("file://{$dir}var/logs/app.log"),
            Url::fromString("file://{$dir}var/logs/amqp/amqp.log"),
            $os->filesystem()->mount(new Path($dir.'var/cache/rest')),
            $os->filesystem()->mount(new Path($dir.'var/logs')),
            $os->filesystem()->mount(new Path($dir.'var/data/states')),
            $os->filesystem()->mount(new Path($dir.'var/data/actions')),
            $os->filesystem()->mount(new Path($dir.'var/cache/traces')),
            $os->filesystem()->mount(new Path($dir.'var/cache/robots_txts')),
            $env->workingDirectory(),
            Transport::tcp(),
            Url::fromString($variables['amqpServer'] ?? 'amqp://guest:guest@localhost:5672/'),
            $variables['apiKey'],
            'Innmind Robot'
        );

        if ($variables->contains('debug')) {
            $commands = $debug['cli'](...$commands);
        }

        $run = new Commands(...$commands);
        $run($env);
    }
};

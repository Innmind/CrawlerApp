#!/usr/bin/env php
<?php
declare(strict_types = 1);

require __DIR__.'/../vendor/autoload.php';

use function Crawler\bootstrap;
use Innmind\CLI\{
    Main,
    Environment,
};
use Innmind\Url\{
    Url,
    Path,
};
use Innmind\Socket\Internet\Transport;
use Innmind\Filesystem\Adapter\FilesystemAdapter;
use Innmind\OperatingSystem\OperatingSystem;
use function Innmind\CLI\variables;

new class extends Main {
    protected function main(Environment $env, OperatingSystem $os): void
    {
        $variables = variables(
            $env->variables(),
            $os->filesystem()->mount(new Path(__DIR__.'/../config'))
        );

        $run = bootstrap(
            $os->clock(),
            $os->process(),
            $os->remote(),
            Url::fromString("file://{$env->workingDirectory()}/var/logs/app.log"),
            Url::fromString("file://{$env->workingDirectory()}/var/logs/amqp/amqp.log"),
            new FilesystemAdapter($env->workingDirectory().'/var/cache/rest'),
            new FilesystemAdapter($env->workingDirectory().'/var/logs'),
            new FilesystemAdapter($env->workingDirectory().'/var/data/states'),
            new FilesystemAdapter($env->workingDirectory().'/var/data/actions'),
            new FilesystemAdapter($env->workingDirectory().'/var/cache/traces'),
            new FilesystemAdapter($env->workingDirectory().'/var/cache/robots_txts'),
            $env->workingDirectory(),
            Transport::tcp(),
            Url::fromString($variables['amqpServer'] ?? 'amqp://guest:guest@localhost:5672/'),
            $variables['apiKey'],
            'Innmind Robot'
        );

        $run($env);
    }
};
